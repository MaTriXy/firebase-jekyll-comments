<html>
<head>
  <title>Example Webpage</title>
  <script src='https://cdn.firebase.com/js/client/1.0.15/firebase.js'></script>
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
  <script src="https://cdn.firebase.com/js/simple-login/1.6.2/firebase-simple-login.js"></script>

  <script>

    $(document).ready(function () {
      //TODO: determine on the fly from the frontmatter / Jekyll config
      var postId = "example-webpage";
      var blogName = "test-blog-please-ignore";

      var fb = new Firebase('https://blogcomments.firebaseio.com/' + blogName);
      var fbPostComments = fb.child(postId);
      var fbPostCommentCount = fb.child("comment-counts/" + postId);

      var currentUser = null;

      // init Auth
      var auth = new FirebaseSimpleLogin(fb, function(error, user) {
        if (error) {
          // An error occurred while attempting login
          console.log(error);
        } else if (user) {
          currentUser = user;
          // User authenticated with Firebase

          // Store user data in Firebase so we can display it on the comments
          fb.child('users').child(user.uid).set({
            displayName: user.displayName,
            provider: user.provider,
            provider_id: user.id
          });
          //TODO: Get profile photo?

          $(".login-button").hide();
          $(".logout-button").show();
        } else {
          // User is logged out
          currentUser = null;

          $(".login-button").show();
          $(".logout-button").hide();
        }
      });

      // Handle login
      $('#login-google').click(function (event) {
        auth.login('google', {
          rememberMe: true,
          scope: 'https://www.googleapis.com/auth/plus.login'
        });
      });
      $('#login-login-anonymous').click(function (event) {
        auth.login('anonymous', {
          rememberMe: true
        });
      });
      $('#logout').click(function (event) {
        auth.logout();
      });

      // Handle insertions
      $('#post-comment').submit(function (event) {
        event.preventDefault();
        var comment = $("#post-comment-value").val();
        fbPostComments.push({'uid': currentUser.uid, 'comment': comment});

        fbPostCommentCount.transaction(function (current_value) {
          return (current_value || 0) + 1;
        });
      });

      // Display existing comments
      fbPostComments.on('child_added', function (snapshot) {
        var message = snapshot.val();
        fb.child("users/" + message.uid).once('value', function(userSnap) {
          var user = userSnap.val();
          var userName = user ? user.displayName : "anonymous";

          $("#comments-list").append($('<dt>').text(userName), $('<dd>').text(message.comment));
        })
      });

      // Update comment count
      fbPostCommentCount.on('value', function (snapshot) {
        $("#comments-header").text(snapshot.val() + " Comments");
      });
    });

  </script>
</head>
<body>
<section id="content">
  <h1>Example Webpage</h1>

  <p>This is an example webpage that illustrates how to use the comment plugin</p>
</section>
<section id="comments">
  <h2 id="comments-header">Comments</h2>

  <input type="button" value="login with Google" id="login-google" class="login-button" style="display: none">
  <input type="button" value="logout" id="logout" class="logout-button" style="display: none">

  <form id="post-comment">
    <h3>Post a new comment</h3>
    <textarea id="post-comment-value" name="comment"></textarea>
    <input type="submit">
  </form>

  <dl id="comments-list">
  </dl>
</section>
</body>
</html>